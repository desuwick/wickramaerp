<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wickrama Hardware - Pickup Order System</title>

    <!-- =========================================================
         STYLES  ‚Äî identical to your last paste (kept verbatim)
    ========================================================== -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}

        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;
            line-height:1.6;
        }
        .container{max-width:1400px;margin:0 auto;padding:15px;}

        /* ---------- Modern Header ---------- */
        .header{
            background:rgba(255,255,255,.95);
            backdrop-filter:blur(20px);
            color:#2c3e50;
            padding:20px 30px;
            border-radius:20px;
            margin-bottom:25px;
            box-shadow:0 20px 40px rgba(0,0,0,.1);
            border:1px solid rgba(255,255,255,.2);
            position:relative;
            display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;
        }
        .logo-section{display:flex;align-items:center;gap:20px;}
        .company-logo{width:60px;height:60px;border-radius:12px;object-fit:cover;border:3px solid #667eea;box-shadow:0 4px 12px rgba(0,0,0,.1);}
        .company-info h1{
            font-size:1.8em;font-weight:700;
            background:linear-gradient(135deg,#667eea,#764ba2);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            background-clip:text;margin-bottom:5px;
        }
        .company-info p{font-size:.9em;color:#666;font-weight:500;}
        .header-actions{display:flex;align-items:center;gap:15px;}
        .manager-status{
            background:linear-gradient(135deg,#11998e,#38ef7d);color:#fff;padding:8px 16px;
            border-radius:25px;font-size:14px;font-weight:600;display:none;
            box-shadow:0 4px 12px rgba(17,153,142,.3);
        }
        .manager-login-btn,.logout-btn{
            background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;
            padding:10px 20px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:600;
            transition:.3s;box-shadow:0 4px 12px rgba(102,126,234,.3);
        }
        .logout-btn{background:linear-gradient(135deg,#ff6b6b,#ee5a24);box-shadow:0 4px 12px rgba(255,107,107,.3);}
        .manager-login-btn:hover,.logout-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.2);}

        /* ---------- Tabs ---------- */
        .tabs{
            display:flex;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);
            border-radius:20px;overflow:hidden;margin-bottom:25px;
            box-shadow:0 10px 30px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2);
        }
        .tab{
            flex:1;padding:18px 15px;background:transparent;border:none;cursor:pointer;
            font-size:15px;font-weight:600;transition:.3s;color:#666;position:relative;
        }
        .tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.3);}
        .tab:hover:not(.active){background:rgba(102,126,234,.1);color:#667eea;}

        .tab-content{
            display:none;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);
            padding:30px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);
            border:1px solid rgba(255,255,255,.2);
        }
        .tab-content.active{display:block;animation:fadeIn .3s ease-in;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

        /* ---------- Stats, cards, forms‚Ä¶ (unchanged) ---------- */
        /* ‚Ä¶  ( Hundreds of lines exactly as in your last paste ) ‚Ä¶ */

    </style>
</head>
<body>
    <div class="container">
        <!-- header / tabs markup unchanged -->

        <!-- Modern Header with Logo -->
        <div class="header">
            <div class="logo-section">
                <img id="company-logo"
                     class="company-logo"
                     src="/uploads/logo.png"
                     alt="Company Logo"
                     style="display:none;">
                <div class="company-info">
                    <h1>Wickrama Hardware Stores</h1>
                    <p>Advanced Pickup Order Management System</p>
                </div>
            </div>

            <div class="header-actions">
                <div class="manager-status" id="manager-status">üë®‚Äçüíº Manager Mode</div>
                <button class="upload-logo-btn manager-only"
                        onclick="handleManagerAction(showLogoUpload)">üì∑ Upload Logo</button>
                <button class="manager-login-btn" id="login-btn"
                        onclick="showLoginModal()">üë®‚Äçüíº Manager Login</button>
                <button class="logout-btn" id="logout-btn"
                        onclick="logout()" style="display:none;">Logout</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab"        onclick="showTab('new-order')">‚ûï New Order</button>
            <button class="tab"        onclick="showTab('orders')">üìã Manage Orders</button>
            <button class="tab"        onclick="showTab('search')">üîç Search</button>
            <button class="tab manager-only"
                    onclick="handleManagerAction(() => showTab('recycle-bin'))">üóëÔ∏è Recycle Bin</button>
        </div>

        <!-- ============= DASHBOARD ============= -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-header">
                <div class="stats-title">
                    üìä Live Statistics
                    <div class="live-indicator"></div>
                </div>
            </div>

            <div class="stats" id="stats-container">
                <!-- stats injected by JS -->
            </div>

            <h3 style="margin-bottom:20px;color:#2c3e50;font-weight:700;">üìã Recent Orders</h3>
            <div id="recent-orders"><!-- recent orders injected --></div>
        </div>

        <!-- ============= NEW ORDER ============= -->
        <div id="new-order" class="tab-content">
            <h2 style="margin-bottom:25px;color:#2c3e50;font-weight:700;">‚ûï Create New Order</h2>
            <div id="order-alert"></div>

            <form id="order-form">
                <div class="form-group">
                    <label for="customer-name">Customer Name *</label>
                    <input type="text" id="customer-name"
                           placeholder="Enter customer's full name" required>
                </div>

                <div class="form-group">
                    <label for="customer-phone">Customer Phone *</label>
                    <input type="tel" id="customer-phone"
                           placeholder="077 123 4567" required>
                </div>

                <div class="form-group">
                    <label>Items List *</label>
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input type="text" name="item-name"
                                           placeholder="e.g. 1-inch PVC Pipe" required>
                                </td>
                                <td>
                                    <input type="number" name="item-qty"
                                           min="1" placeholder="Qty" required>
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-danger"
                                            onclick="removeItemRow(this)"
                                            style="padding:8px 12px;margin:0;">‚ùå</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn"
                            style="margin-top:15px;"
                            onclick="addItemRow()">‚ûï Add Another Item</button>
                </div>

                <div class="form-group">
                    <label for="payment-method">Payment Method *</label>
                    <select id="payment-method" required>
                        <option value="">Select payment method</option>
                        <option value="cash">üí∞ Cash on Pickup</option>
                        <option value="prepaid">üí≥ Prepaid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="staff-name">Staff Name *</label>
                    <input type="text" id="staff-name"
                           placeholder="Enter your name" required>
                </div>

                <button type="submit"
                        class="btn btn-success"
                        style="font-size:18px;padding:18px 40px;">üöÄ Create Order</button>
            </form>
        </div>

        <!-- ============= MANAGE ORDERS ============= -->
        <div id="orders" class="tab-content">
            <h2 style="margin-bottom:25px;color:#2c3e50;font-weight:700;">üìã Manage Orders</h2>

            <div class="search-bar">
                <select id="status-filter" onchange="filterOrders()">
                    <option value="all">All Statuses</option>
                    <option value="received">Received</option>
                    <option value="approved">Approved</option>
                    <option value="packed">Packed</option>
                    <option value="ready">Ready for Pickup</option>
                    <option value="completed">Completed</option>
                </select>
                <button class="btn" onclick="loadOrders()">üîÑ Refresh Orders</button>
            </div>

            <div id="orders-container"><!-- orders injected --></div>
        </div>

        <!-- ============= SEARCH ============= -->
        <div id="search" class="tab-content">
            <h2 style="margin-bottom:25px;color:#2c3e50;font-weight:700;">üîç Search Orders</h2>

            <div class="search-bar">
                <input type="text" id="search-input"
                       placeholder="Search by customer name, phone, or order #">
                <select id="search-status-filter">
                    <option value="all">All Statuses</option>
                    <option value="received">Received</option>
                    <option value="approved">Approved</option>
                    <option value="packed">Packed</option>
                    <option value="ready">Ready for Pickup</option>
                    <option value="completed">Completed</option>
                </select>
                <button class="btn" onclick="searchOrders()">üîç Search</button>
            </div>

            <div id="search-results"><!-- results injected --></div>
        </div>

        <!-- ============= RECYCLE BIN ============= -->
        <div id="recycle-bin" class="tab-content">
            <h2 style="margin-bottom:25px;color:#2c3e50;font-weight:700;">üóëÔ∏è Recycle Bin</h2>

            <div class="alert" style="background:rgba(255,165,2,.1);color:#cc5500;border-left:4px solid #ffa502;">
                <strong>‚ÑπÔ∏è Auto-Cleanup Policy:</strong>
                Orders in recycle-bin are automatically permanently deleted after 7 days
                (data exported before deletion).
            </div>

            <div class="search-bar">
                <div id="recycle-stats"
                     style="flex:1;padding:15px;background:rgba(102,126,234,.1);
                            border-radius:12px;margin-right:15px;font-weight:600;">
                    <strong>Recycle Bin:</strong> <span id="recycle-count">0</span> orders |
                    <strong>Expiring Soon:</strong> <span id="expiring-count">0</span> orders
                </div>
                <button class="btn"        onclick="loadRecycleBin()">üîÑ Refresh</button>
                <button class="btn btn-danger" onclick="confirmEmptyRecycleBin()">üóëÔ∏è Empty All</button>
            </div>

            <div id="recycle-bin-container"><!-- deleted orders injected --></div>
        </div>
    </div><!-- /.container -->

    <!-- ============= MODALS ============= -->
    <!-- Manager Login -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <h3>üîê Manager Login</h3>
            <div id="login-alert"></div>
            <form onsubmit="login(event)">
                <input type="text"     id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn btn-success">üöÄ Login</button>
                <button type="button" class="btn" onclick="closeLoginModal()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Logo Upload -->
    <div class="modal" id="logo-upload-modal">
        <div class="modal-content">
            <h3>üì∑ Upload Company Logo</h3>
            <div id="logo-upload-alert"></div>
            <form id="logo-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="logo-file">Choose Logo (PNG/JPG, max 5 MB)</label>
                    <input type="file" id="logo-file" name="logo"
                           accept="image/*" required style="padding:10px;">
                </div>
                <button type="submit" class="btn btn-success">üì§ Upload Logo</button>
                <button type="button" class="btn" onclick="closeLogoUploadModal()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Thermal Printer Label -->
    <div class="print-label" id="print-label">
        <div class="label-content">
            <div class="label-header">WICKRAMA HARDWARE</div>
            <div class="label-divider"></div>

            <div class="label-row"><strong>ORDER:</strong><span id="label-order-number"></span></div>
            <div class="label-row"><strong>INVOICE:</strong><span id="label-invoice-number"></span></div>
            <div class="label-row"><strong>PAYMENT:</strong><span id="label-payment-method"></span></div>
            <div class="label-row"><strong>CUSTOMER:</strong><span id="label-customer-name"></span></div>

            <div class="label-divider"></div>
            <div class="label-footer">
                Generated: <span id="label-timestamp"></span><br>
                Thank you for choosing us!
            </div>
        </div>
    </div>

    <!-- ============= SCRIPTS ============= -->
    <script>
/* ------------------------------------------------------------------
   Global state vars
------------------------------------------------------------------ */
let currentOrders         = [];
let currentStats          = {};
let currentDeletedOrders  = [];
let recycleBinStats       = {};
let isManagerLoggedIn     = false;

/* --------------------------------------------------------------
   WhatsApp helpers ‚Äì keep just above window.onload
-------------------------------------------------------------- */
function formatPhoneForWhatsApp(raw){
    let d = raw.replace(/\D/g,'');
    if(d.startsWith('0')) d = '94'+d.slice(1);
    return d;
}
function buildWhatsAppLink(phone,orderNo){
    const msg = encodeURIComponent(
        `Your order ${orderNo} is ready for pickup at Wickrama Hardware. Thank you!`
    );
    return `https://wa.me/${formatPhoneForWhatsApp(phone)}?text=${msg}`;
}

/* --------------------------------------------------------------
   On load ‚Äì restore login state, load logo & dashboard
-------------------------------------------------------------- */
window.onload = () => {
    const saved = localStorage.getItem('managerLoggedIn') === 'true';
    if(saved){ isManagerLoggedIn = true; setManagerMode(true); }
    loadLogo();
    loadDashboard();
};

/* --------------------------------------------------------------
   Logo handling
-------------------------------------------------------------- */
async function loadLogo(){
    try{
        const res   = await fetch('/api/logo');
        const json  = await res.json();
        if(json.success && json.hasLogo){
            const img = document.getElementById('company-logo');
            img.src   = json.logoUrl+'?t='+Date.now(); /* cache-bust */
            img.style.display='block';
        }
    }catch(err){ console.error('logo error',err); }
}

/* Show / hide Upload-Logo modal */
function showLogoUpload(){ document.getElementById('logo-upload-modal').classList.add('show'); }
function closeLogoUploadModal(){
    document.getElementById('logo-upload-modal').classList.remove('show');
    document.getElementById('logo-upload-alert').innerHTML='';
}

/* --------------------------------------------------------------
   Upload-logo submit handler
-------------------------------------------------------------- */
document.getElementById('logo-upload-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const file = document.getElementById('logo-file').files[0];
    if(!file){ return showAlert('logo-upload-alert','Please select a logo file','error'); }

    if(file.size > 5*1024*1024){
        return showAlert('logo-upload-alert','Logo must be < 5 MB','error');
    }

    const fd = new FormData();
    fd.append('logo', file);
    fd.append('staffName', localStorage.getItem('managerName') || 'manager');

    try{
        const res  = await fetch('/api/upload-logo',{method:'POST',body:fd});
        const json = await res.json();
        if(json.success){
            showAlert('logo-upload-alert','Logo uploaded successfully!','success');
            loadLogo();
            setTimeout(closeLogoUploadModal,2000);
        }else{
            showAlert('logo-upload-alert',json.error||'Upload failed','error');
        }
    }catch(err){
        showAlert('logo-upload-alert','Network error','error');
    }
});

/* --------------------------------------------------------------
   Login modal helpers
-------------------------------------------------------------- */
function showLoginModal(){ document.getElementById('login-modal').classList.add('show'); }
function closeLoginModal(){
    document.getElementById('login-modal').classList.remove('show');
    document.getElementById('login-alert').innerHTML='';
}

/* Simple in-browser credentials (demo only!) */
const validCredentials = {
    'manager'    : 'manager123',
    'supervisor' : 'super123',
    'supervisor1': 'super123'
};

async function login(evt){
    evt.preventDefault();
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value.trim();

    if(validCredentials[u] === p){
        setManagerMode(true);
        localStorage.setItem('managerLoggedIn','true');
        localStorage.setItem('managerName',u);
        closeLoginModal();
    }else{
        showAlert('login-alert','Invalid credentials','error');
    }
}

function logout(){
    setManagerMode(false);
    localStorage.removeItem('managerLoggedIn');
    localStorage.removeItem('managerName');
}

/* --------------------------------------------------------------
   Manager mode toggling
-------------------------------------------------------------- */
function setManagerMode(enabled){
    isManagerLoggedIn = enabled;
    document.getElementById('manager-status').style.display = enabled ? 'block' : 'none';
    document.getElementById('login-btn'     ).style.display = enabled ? 'none'  : 'block';
    document.getElementById('logout-btn'    ).style.display = enabled ? 'block' : 'none';

    document.querySelectorAll('.manager-only').forEach(el=>{
        if(enabled){
            el.classList.add('enabled');
            Object.assign(el.style,{opacity:'1',cursor:'pointer',filter:'none'});
        }else{
            el.classList.remove('enabled');
            Object.assign(el.style,{opacity:'.6',cursor:'not-allowed',filter:'grayscale(50%)'});
        }
    });

    /* If user was on recycle-bin and logs out, bounce back to dashboard */
    if(!enabled && document.getElementById('recycle-bin').classList.contains('active')){
        showTab('dashboard');
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelector('.tab[onclick*="dashboard"]').classList.add('active');
    }
}
function handleManagerAction(fn){
    if(!isManagerLoggedIn){ showLoginModal(); return; }
    fn();
}

/* --------------------------------------------------------------
   Tab switching
-------------------------------------------------------------- */
function showTab(name){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));

    document.getElementById(name).classList.add('active');
    event.target.classList.add('active');

    switch(name){
        case 'dashboard'  : loadDashboard();  break;
        case 'orders'     : loadOrders();     break;
        case 'recycle-bin': loadRecycleBin(); break;
    }
}

/* --------------------------------------------------------------
   Order-form helpers
-------------------------------------------------------------- */
function addItemRow(){
    const tbody = document.querySelector('#items-table tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" name="item-name" placeholder="Enter item name" required></td>
        <td><input type="number" name="item-qty"  min="1" placeholder="Qty" required></td>
        <td><button type="button" class="btn btn-danger"
                    onclick="removeItemRow(this)"
                    style="padding:8px 12px;margin:0;">‚ùå</button></td>`;
    tbody.appendChild(tr);
}
function removeItemRow(btn){
    const tbody = document.querySelector('#items-table tbody');
    if(tbody.children.length>1){ btn.closest('tr').remove(); }
    else{ alert('At least one item is required'); }
}

/* --------------------------------------------------------------
   Dashboard / stats
-------------------------------------------------------------- */
async function loadDashboard(){
    try{
        const [statsRes, binRes, ordRes] = await Promise.all([
            fetch('/api/stats'),
            fetch('/api/recycle-bin/stats'),
            fetch('/api/orders')
        ]);
        currentStats       = await statsRes.json();
        recycleBinStats    = await binRes.json();
        const orders       = await ordRes.json();

        displayStats();
        displayRecentOrders(orders.slice(-5).reverse());
    }catch(err){ console.error('dashboard error',err); }
}
function displayStats(){
    const s = currentStats, r = recycleBinStats;
    const expCls = r.expiringSoon>0 ? 'recycle-bin expiring':'recycle-bin';
    document.getElementById('stats-container').innerHTML = `
        ${stat('Active Orders' ,s.total)}
        ${stat("Today's Orders",s.today)}
        ${stat('Received',s.received)}
        ${stat('Approved',s.approved)}
        ${stat('Packed',s.packed)}
        ${stat('Ready',s.ready)}
        ${stat('Completed',s.completed)}
        ${stat('Recycle Bin',r.total,expCls)}
    `;
    function stat(label,val,extra=''){
        return `<div class="stat-card ${extra}">
                    <div class="stat-number">${val||0}</div>
                    <div class="stat-label">${label}</div>
                </div>`;
    }
}
function displayRecentOrders(arr){
    const c = document.getElementById('recent-orders');
    if(arr.length===0){
        return c.innerHTML = blank('No Recent Orders',
                                   'Recent orders will appear here once created.');
    }
    c.innerHTML = arr.map(o=>createOrderCard(o)).join('');
}
/* helper blank-state */
function blank(title,msg){
    return `<div style="text-align:center;padding:40px;background:rgba(102,126,234,.05);
                         border-radius:15px;border:2px dashed #667eea;">
                <h3>üìã ${title}</h3><p>${msg}</p></div>`;
}

/* --------------------------------------------------------------
   Create order (submit)
-------------------------------------------------------------- */
document.getElementById('order-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const rows  = [...document.querySelectorAll('#items-table tbody tr')];
    const items = rows.map(r=>{
        const n = r.querySelector('[name="item-name"]').value.trim();
        const q = r.querySelector('[name="item-qty"]').value.trim();
        return `${q}x ${n}`;
    }).join(', ');

    const body = JSON.stringify({
        customerName : document.getElementById('customer-name').value,
        customerPhone: document.getElementById('customer-phone').value,
        items,
        paymentMethod: document.getElementById('payment-method').value,
        staffName    : document.getElementById('staff-name').value
    });

    try{
        const res  = await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body});
        const json = await res.json();
        if(json.success){
            showAlert('order-alert',`üéâ Order created! #${json.order_number}`,'success');
            e.target.reset();
            /* reset rows to single */
            document.querySelector('#items-table tbody').innerHTML = `
                <tr>
                    <td><input type="text" name="item-name" placeholder="e.g. 1-inch PVC Pipe" required></td>
                    <td><input type="number" name="item-qty"  min="1" placeholder="Qty" required></td>
                    <td><button type="button" class="btn btn-danger"
                                onclick="removeItemRow(this)"
                                style="padding:8px 12px;margin:0;">‚ùå</button></td>
                </tr>`;
        }else{
            showAlert('order-alert','‚ùå '+(json.error||'Error creating order'),'error');
        }
    }catch(err){
        showAlert('order-alert','‚ùå Network error','error');
    }
});

/* --------------------------------------------------------------
   Manage orders list
-------------------------------------------------------------- */
async function loadOrders(){
    try{
        const res = await fetch('/api/orders');
        currentOrders = await res.json();
        filterOrders();
    }catch(err){ console.error('orders error',err); }
}
function filterOrders(){
    const f = document.getElementById('status-filter').value;
    const list = f==='all'? currentOrders : currentOrders.filter(o=>o.status===f);
    displayOrders(list);
}
function displayOrders(arr){
    const c = document.getElementById('orders-container');
    if(arr.length===0){ return c.innerHTML = blank('No Orders Found','Try different filter.'); }
    c.innerHTML = arr.map(o=>createOrderCard(o,true)).join('');
}

/* --------------------------------------------------------------
   Order-card generator (HTML)
-------------------------------------------------------------- */
function createOrderCard(o,actions=false){
    const stCls = 'status-'+o.status.replace(' ','-');
    const canApprove   = o.status==='received' && o.approvals.length<3;
    const canPack      = o.status==='approved';
    const canReady     = o.status==='packed';
    const canComplete  = o.status==='ready';

    const progress = `
      <div class="progress-bar">
        <strong>Approval Progress: ${o.approvals.length}/3</strong>
        <div class="progress-track">
            <div class="progress-fill" style="width:${(o.approvals.length/3)*100}%"></div>
        </div>
      </div>`;

    const approvals = o.approvals.length?`
      <div class="approvals"><strong>‚úÖ Approvals (${o.approvals.length}/3):</strong>
         ${o.approvals.map(a=>`
            <div class="approval">
               <span><strong>${a.staff}</strong></span>
               <span>${new Date(a.timestamp).toLocaleString()}</span>
            </div>`).join('')}
      </div>`:'';

    const mgrBtns = actions?`
      <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(102,126,234,.1);">
        ${canApprove?btn('btn-warning','‚úÖ Approve',()=>approveOrder(o.order_number)):''}
        ${(o.status==='received'||o.status==='approved')?btn('','üìÑ Set Invoice',()=>updateInvoiceNumber(o.order_number)):''}
        ${canPack?   btn('btn-success','üì¶ Mark as Packed',()=>updateOrderStatus(o.order_number,'packed')):''}
        ${canReady?  btn('btn-success','‚úÖ Mark as Ready', ()=>updateOrderStatus(o.order_number,'ready')):''}
        ${canComplete?btn('','üèÅ Mark as Completed',()=>updateOrderStatus(o.order_number,'completed')):''}
        ${(o.status==='packed'||o.status==='ready')?`<button class="btn" onclick="printLabel('${o.order_number}')">üñ®Ô∏è Print Thermal Label</button>`:''}
        ${btn('btn-danger','üóëÔ∏è Move to Recycle Bin',()=>deleteOrder(o.order_number))}
      </div>`:'';

    function btn(cls,label,fn){
        const dis = isManagerLoggedIn?'enabled':'';
        return `<button class="btn ${cls} manager-only ${dis}" onclick="handleManagerAction(${fn})">${label}</button>`;
    }

    return `<div class="order-card">
        <div class="order-header">
            <div class="order-number">${o.order_number}</div>
            <div class="status-badge ${stCls}">${o.status.toUpperCase()}</div>
        </div>

        <div class="order-details">
            <div class="detail-group">
                <strong>üë§ Customer Info</strong><br>
                <strong>Name:</strong> ${o.customer_name}<br>
                <strong>Phone:</strong> ${o.customer_phone}
            </div>
            <div class="detail-group">
                <strong>üí≥ Order Details</strong><br>
                <strong>Payment:</strong> ${o.payment_method}<br>
                <strong>Invoice:</strong> ${o.invoice_number||'Not set'}
            </div>
            <div class="detail-group">
                <strong>üìÖ Timeline</strong><br>
                <strong>Created:</strong> ${new Date(o.created_at).toLocaleDateString()}<br>
                <strong>By:</strong> ${o.created_by}
            </div>
        </div>

        <div style="margin:20px 0;padding:15px;background:rgba(102,126,234,.05);
                    border-radius:12px;border-left:4px solid #667eea;">
            <strong>üì¶ Items:</strong> ${o.items}
        </div>

        ${progress}${approvals}${mgrBtns}
    </div>`;
}

/* --------------------------------------------------------------
   Approvals, status-changes & invoice number
-------------------------------------------------------------- */
async function approveOrder(orderNo){
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const res  = await fetch(`/api/orders/${orderNo}/approve`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({staffName:staff})
        });
        const j = await res.json();
        if(j.success){
            alert(`‚úÖ Approval added (${j.approvals}/3)`);
            loadOrders(); loadDashboard();
        }else{ alert('‚ùå '+(j.error||'Approve failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

async function updateOrderStatus(orderNo,status){
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const res  = await fetch(`/api/orders/${orderNo}/status`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({status,staffName:staff})
        });
        const j = await res.json();
        if(j.success){
            alert(`‚úÖ Status set to ${status.toUpperCase()}`);
            /* When order becomes ready ‚Äì send WhatsApp link */
            if(status==='ready'){
                const ord = currentOrders.find(o=>o.order_number===orderNo);
                if(ord){ window.open(buildWhatsAppLink(ord.customer_phone,ord.order_number),'_blank'); }
            }
            loadOrders(); loadDashboard();
        }else{ alert('‚ùå '+(j.error||'Update failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

async function updateInvoiceNumber(orderNo){
    const inv = prompt('üìÑ Enter invoice number from ERP:');
    if(!inv){ return; }
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const ord = currentOrders.find(o=>o.order_number===orderNo);
        if(!ord){ return; }
        const res  = await fetch(`/api/orders/${orderNo}/status`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({status:ord.status,staffName:staff,invoiceNumber:inv})
        });
        const j = await res.json();
        if(j.success){ alert('‚úÖ Invoice updated'); loadOrders(); }
        else{ alert('‚ùå '+(j.error||'Failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

/* --------------------------------------------------------------
   Delete to recycle-bin
-------------------------------------------------------------- */
async function deleteOrder(orderNo){
    if(!confirm('üóëÔ∏è Move this order to recycle bin?')){ return; }
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const res = await fetch(`/api/orders/${orderNo}`,{
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({staffName:staff})
        });
        const j = await res.json();
        if(j.success){ alert('‚úÖ Order moved'); loadOrders(); loadDashboard(); }
        else{ alert('‚ùå '+(j.error||'Failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

/* --------------------------------------------------------------
   Search
-------------------------------------------------------------- */
async function searchOrders(){
    const q      = document.getElementById('search-input').value;
    const status = document.getElementById('search-status-filter').value;
    const p      = new URLSearchParams();
    if(q) p.append('q',q);
    if(status!=='all') p.append('status',status);
    try{
        const res = await fetch(`/api/search?${p.toString()}`);
        const arr = await res.json();
        const c   = document.getElementById('search-results');
        c.innerHTML = arr.length? arr.map(o=>createOrderCard(o,true)).join('')
                                : blank('No Results Found','Try adjusting search.');
    }catch(e){ console.error(e); }
}

/* --------------------------------------------------------------
   Thermal-label printing
-------------------------------------------------------------- */
async function printLabel(orderNo){
    try{
        const res  = await fetch(`/api/orders/${orderNo}`);
        const o    = await res.json();
        if(!o.invoice_number){ return alert('‚ö†Ô∏è Set invoice number first'); }

        document.getElementById('label-order-number').textContent   = o.order_number;
        document.getElementById('label-customer-name').textContent  = o.customer_name;
        document.getElementById('label-invoice-number').textContent = o.invoice_number;
        document.getElementById('label-payment-method').textContent = o.payment_method.toUpperCase();
        document.getElementById('label-timestamp').textContent      = new Date().toLocaleString();

        document.getElementById('print-label').classList.add('show');
        setTimeout(()=>{ window.print(); 
                         document.getElementById('print-label').classList.remove('show'); },500);
    }catch(e){ alert('‚ùå Error loading order'); }
}

/* --------------------------------------------------------------
   Recycle-bin helpers
-------------------------------------------------------------- */
async function loadRecycleBin(){
    try{
        const [oRes,sRes] = await Promise.all([
            fetch('/api/deleted-orders'),
            fetch('/api/recycle-bin/stats')
        ]);
        currentDeletedOrders = await oRes.json();
        updateRecycleBinStats(await sRes.json());
        displayDeletedOrders(currentDeletedOrders);
    }catch(e){
        console.error(e);
        document.getElementById('recycle-bin-container').innerHTML = '<p>‚ùå Error loading</p>';
    }
}
function updateRecycleBinStats(st){
    document.getElementById('recycle-count').textContent   = st.total||0;
    document.getElementById('expiring-count').textContent  = st.expiringSoon||0;
    const el = document.getElementById('expiring-count');
    if(st.expiringSoon>0){ el.style.color='#e74c3c'; el.style.fontWeight='bold'; }
    else{ el.style.color=''; el.style.fontWeight=''; }
}

function displayDeletedOrders(arr){
    const c = document.getElementById('recycle-bin-container');
    if(arr.length===0){ return c.innerHTML = blank('Recycle Bin is Empty','Nothing to restore.'); }
    c.innerHTML = arr.map(o=>createDeletedOrderCard(o)).join('');
}

function createDeletedOrderCard(o){
    const del = new Date(o.deleted_at);
    const days = Math.floor((Date.now()-del)/(1000*60*60*24));
    const remain = Math.max(0,7-days);
    const urgent = remain<=2;
    return `<div class="order-card" style="${urgent?'border-left:4px solid #e74c3c;':''}">
        <div class="order-header">
            <div class="order-number">${o.order_number}</div>
            <div class="status-badge status-deleted">DELETED</div>
        </div>
        <div class="order-details">
            <div class="detail-group"><strong>üë§ Customer</strong><br>
                <strong>Name:</strong> ${o.customer_name}<br>
                <strong>Phone:</strong> ${o.customer_phone}</div>
            <div class="detail-group"><strong>üìã Info</strong><br>
                <strong>Original:</strong> ${o.original_status||'Unknown'}<br>
                <strong>Payment :</strong> ${o.payment_method}</div>
            <div class="detail-group"><strong>üóëÔ∏è Deleted</strong><br>
                <strong>Date:</strong> ${del.toLocaleDateString()}<br>
                <strong>By:</strong> ${o.deleted_by}</div>
        </div>
        <div style="margin:20px 0;padding:15px;background:rgba(102,126,234,.05);
                    border-radius:12px;border-left:4px solid #667eea;">
            <strong>üì¶ Items:</strong> ${o.items}
        </div>
        <div style="margin-top:20px;padding:15px;background:${urgent?'rgba(255,107,107,.1)':'rgba(255,165,2,.1)'};
                     border-radius:12px;border-left:4px solid ${urgent?'#ff6b6b':'#ffa502'};">
            <strong>‚è∞ Auto-deletion in: ${remain} day${remain!==1?'s':''}</strong>
            ${urgent?'<br><span style="color:#e74c3c;font-weight:bold;">‚ö†Ô∏è Will be deleted soon!</span>':''}
        </div>
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(102,126,234,.1);">
            <button class="btn btn-success" onclick="restoreOrder('${o.order_number}')">‚ôªÔ∏è Restore</button>
            <button class="btn btn-danger"  onclick="permanentlyDeleteOrder('${o.order_number}')">üóëÔ∏è Delete Forever</button>
        </div>
    </div>`;
}

async function restoreOrder(orderNo){
    if(!confirm('‚ôªÔ∏è Restore this order?')){ return; }
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const res = await fetch(`/api/orders/${orderNo}/restore`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({staffName:staff})
        });
        const j = await res.json();
        if(j.success){ alert('‚úÖ Restored'); loadRecycleBin(); loadDashboard(); }
        else{ alert('‚ùå '+(j.error||'Failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

async function permanentlyDeleteOrder(orderNo){
    if(!confirm('‚ö†Ô∏è PERMANENTLY DELETE this order?\nThis cannot be undone.')){ return; }
    const staff = localStorage.getItem('managerName') || 'manager';
    try{
        const res = await fetch(`/api/deleted-orders/${orderNo}`,{
            method:'DELETE',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({staffName:staff})
        });
        const j = await res.json();
        if(j.success){ alert('‚úÖ Permanently deleted'); loadRecycleBin(); loadDashboard(); }
        else{ alert('‚ùå '+(j.error||'Failed')); }
    }catch(e){ alert('‚ùå Network error'); }
}

async function confirmEmptyRecycleBin(){
    if(currentDeletedOrders.length===0){ return alert('Recycle bin is already empty'); }
    if(!confirm(`‚ö†Ô∏è Empty recycle-bin? This will delete ${currentDeletedOrders.length} orders permanently.`)){ return; }
    const staff = localStorage.getItem('managerName') || 'manager';
    let ok=0, fail=0;
    for(const o of currentDeletedOrders){
        try{
            const r = await fetch(`/api/deleted-orders/${o.order_number}`,{
                method:'DELETE',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({staffName:staff})
            });
            if(r.ok){ ok++; } else{ fail++; }
        }catch{ fail++; }
    }
    alert(`Recycle-bin emptied.\nSuccess: ${ok}\nFailed: ${fail}`);
    loadRecycleBin(); loadDashboard();
}

/* --------------------------------------------------------------
   Utility alert
-------------------------------------------------------------- */
function showAlert(id,msg,type){
    const box = document.getElementById(id);
    if(!box){ return; }
    const cls = type==='success'?'alert-success':'alert-error';
    box.innerHTML = msg?`<div class="alert ${cls}">${msg}</div>`:'';
    if(msg){ setTimeout(()=>{ box.innerHTML=''; },5000); }
}

/* --------------------------------------------------------------
   Auto-refresh dashboard every 30 s
-------------------------------------------------------------- */
setInterval(()=>{ 
    if(document.getElementById('dashboard').classList.contains('active')){ loadDashboard(); } 
},30000);

/* --------------------------------------------------------------
   Close modals when clicking outside
-------------------------------------------------------------- */
window.onclick = e=>{
    if(e.target===document.getElementById('login-modal')){ closeLoginModal(); }
    if(e.target===document.getElementById('logo-upload-modal')){ closeLogoUploadModal(); }
};
</script>
</body>
</html>
